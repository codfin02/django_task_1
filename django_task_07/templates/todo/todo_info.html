{% extends 'todo/base.html' %}
{% block content %}
<div class="mt-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1>{{ todo.title }}</h1>
    <div class="d-flex">
      <button class="btn btn-primary me-2" onclick="location.href='{% url 'cbv_todo_update' todo.id %}'">수정하기</button>
      <form method="POST" action="{% url 'cbv_todo_delete' todo.id %}">
        {% csrf_token %}
        <button id="delete-button" type="submit" class="btn btn-danger">삭제하기</button>
      </form>
    </div>
  </div>
  <table class="table">
    {% for key, value in todo.items %}
      {% if key != 'title' and key != 'id' and key != 'user_id' and key != '_state' and key != '_prefetched_objects_cache' %}
        <tr>
          <th class="bg-light">{{ key }}</th>
          <td>{{ value }}</td>
        </tr>
      {% endif %}
    {% endfor %}
  </table>
</div>

<div class="mt-4">
  <h3>Comment</h3>
  <hr>
  <form method="POST" action="{% url 'comment_create' todo.id %}" class="mb-3">
    {% csrf_token %}
    {{ comment_form.as_p }}
    <button class="btn btn-primary">댓글달기</button>
  </form>
  <ul class="list-unstyled" id="comment_wrapper">
    {% for comment in page_obj %}
      <li class="p-3 mb-2 border rounded">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <strong>{{ comment.user }}</strong>
          </div>
          {% if request.user == comment.user or request.user.is_superuser %}
          <div>
            <form method="POST" action="{% url 'comment_delete' comment.id %}" class="d-inline">
              {% csrf_token %}
              <div class="btn-group-sm">
                <button class="btn btn-secondary" type="button" onclick="modify_view({{ comment.id }})">수정하기</button>
                <button type="submit" class="btn btn-danger">삭제하기</button>
              </div>
            </form>
          </div>
          {% endif %}
        </div>
        <hr>
        <div>
          <p class="mb-1">{{ comment.message }}</p>
          <p class="text-end text-muted">{{ comment.created_at }}</p>
        </div>
        <form id="comment_modify_form_{{ comment.id }}" style="display: none" method="POST" action="{% url 'comment_update' comment.id %}">
          {% csrf_token %}
          {{ comment_form.as_p }}
          <button class="btn btn-primary btn-sm">수정하기</button>
        </form>
      </li>
    {% empty %}
      <li class="text-muted">댓글이 없습니다.</li>
    {% endfor %}
  </ul>
  {% include 'todo/pagination.html' with fragment='comment_wrapper' %}
</div>

<script>
  function modify_view(commentId) {
    const modifyForm = document.getElementById(`comment_modify_form_${commentId}`);
    if (modifyForm.style.display === "none") {
      modifyForm.style.display = "";
    } else {
      modifyForm.style.display = "none";
    }
  }
</script>
{% endblock %}

